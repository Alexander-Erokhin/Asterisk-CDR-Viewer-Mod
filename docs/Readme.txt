===============================================
 Системные требования
===============================================

PHP 5.3 и выше
База данных Mysql
Веб-сервер Apache или Nginx


===============================================
 Для чего файл "Старый код form.tpl.txt" ?
===============================================

Из файла "templates/form.tpl" вырезан лишний функционал. Однако для тех, кому этот функционал необходим, могут его очень просто вернуть.
В файле "templates/form.tpl" оставлены комментарии точно в тех местах, откуда было вырезано. В файле "Старый код form.tpl.txt" можно найти такие же комментарии.
Ниже комментария в этом файле расположен код, который был вырезан. Если вам нужен какой-либо вырезанный функционал, просто берете код из этого файла и
вставляете вместо комментария в файл "templates/form.tpl".

===============================================
 Создание таблицы в базе
===============================================

Имя файла записи разговора будет храниться в базе Mysql. Как настроить Asterisk для работы с MySql можно найти в интернете. / http://blog.thecall.ru/page/asterisk-18-cdr-v-mysql-cdr_adaptive_odbc /
Допусти мы настроили Asterisk для работы с базой и уже создали таблицу, например "cdr". Теперь нам необходимо добавить с нашу таблицу новую колонку "filename", в которой будет
имя файла с записью, удобнее это сделать через phpmyadmin. / `filename` varchar(255) DEFAULT 'none' / 

===============================================
 Настройка Asterisk
===============================================

Настройки для extensions.ael.

В "globals" добавим пару переменных:

RECORDING=1;	// 1-вкл / 0-выкл запись разговора
DIR_RECORDS=/var/calls/;	// папка с записями разговоров

Добавим макрос.
Сразу уточним, что в этом макросе запись прямо во время разговора конвертируется в MP3.

// MixMonitor
macro recording(calling,called) {
	if ("${RECORDING}" = "1") {
		Set(fname=${UNIQUEID}-${STRFTIME(${EPOCH},,%Y-%m-%d-%H_%M)}-${calling}-${called});
		Set(monopt=nice -n 19 /usr/bin/lame -b 32  --silent "${DIR_RECORDS}${fname}.wav"  "${DIR_RECORDS}${fname}.mp3" && rm -f "${DIR_RECORDS}${fname}.wav" && chmod o+r "${DIR_RECORDS}${fname}.mp3");
		Set(CDR(filename)=${fname}.mp3);
		Set(CDR(realdst)=${called});
		MixMonitor(${DIR_RECORDS}${fname}.wav,b,${monopt});
   }
   return;
};

Пример вызова макроса:
context internal {
	_X. => {
		&recording(${CALLERID(num)},${EXTEN});
		Dial(SIP/${EXTEN},60);
		Hangup();
	};
};


===============================================
 Настройка папки со звонками
===============================================

Записи разговоров будут складываться в папку "/var/calls/" из примера выше. Каждый день в 00.01 часов записи из этой папки по CRON должны распределяться по дате
в соответствующие папки.

Формат хранения записей (пример): /var/calls/2014/2014-09/2014-09-29
Такой формат хранения используется в этом скрипте!

Примерный скрипт для распределения файлов:
===
#!/bin/bash
y=`date +%Y`
ym=`date +%Y-%m -d "-1 day"`
ymd=`date +%Y-%m-%d -d "-1 day"`
mkdir -p /records/mp3/$ym/$ymd/
mv /var/calls/*$ymd* /var/calls/$y/$ym/$ymd/
===

===============================================
 Настройка скрипта
===============================================

Все настройки скрипта прописаны в файле "inc/config.inc.php" с подробными комментариями, тут не должно возникнуть сложностей.

Кратко:
1. Скачать ZIP архив с GitHub или выполнить git@github.com:prog-it/Asterisk-CDR-Viewer-Mod.git
2. Распаковать / перенести файлы в нужную папку на сервере
3. Настроить параметры в "inc/config.inc.php"
4. Почти готово. Если необходим доступ только для определенных пользователей, то необходимо создать файл .htpasswd

htpasswd -c /path/to/.htpasswd admin

Пример конфига для Nginx:
===
location /path/to/script {
	auth_basic "Asterisk";
	auth_basic_user_file /path/to/.htpasswd;
}
===

Пример конфига для Apache:
===
<Location "/cdr/">
	AuthName "Asterisk"
	AuthType Basic
	AuthUserFile /path/to/.htpasswd
	AuthGroupFile /dev/null
	require valid-user
</Location>
===

5. Прописать в конфиге скрипта имена пользователей, которым разрешен доступ
===
$admin_user_names = 'admin1,admin2,admin3';
===


===============================================
 Настройка тарифов на звонки
===============================================

Тарифы на звонки задаются в файле gen_callrates.csv. Его имя можно изменить в конфиге.

Формат задания тарифы в CSV файле:
Код_региона,стоимость_минуты[,Направление,Тип_тарификации,Доп_тариф]

-- То, что в фигурных скобках - необязательно

Пример для Мегафона, с поминутной тарификацией, стоимость первой минуты 90 коп., после первой минуты 10 коп.
===
8922,0.90,Мегафон,m,0.10
===

Типы тарификации:
	s		- посекундно (нет доп. тарифа)
	m		- поминутно (есть доп. тариф)
	c		- за весь звонок (нет доп. тарифа)
	1m+s	- посекундно со 2 минуты (есть доп. тариф)
	30s+s	- посекундно  после 30 секунды
	30s+6s	- 

===============================================

Остальное можно прочитать с файле "Старый ReadMe.txt"	
	
	
